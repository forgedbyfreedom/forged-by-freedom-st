name: Fetch and Build Master Transcripts

on:
  workflow_dispatch:     # manual trigger from GitHub UI
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests openai beautifulsoup4

      - name: Auto-discover and sync transcripts
        run: |
          echo "üì° Starting auto-discovery transcript sync..."
          mkdir -p transcripts_fetched
          find . -type f -name "*.txt" -not -path "./transcripts_fetched/*" -exec cp {} transcripts_fetched/ \;
          echo "‚úÖ Copied transcript files:"
          ls -l transcripts_fetched || echo "No transcripts found."

      - name: Build master transcript bundle
        run: |
          echo "üìò Building master transcript bundle..."
          mkdir -p build_output
          if ls transcripts_fetched/*.txt 1> /dev/null 2>&1; then
            cat transcripts_fetched/*.txt > build_output/master_transcript_combined.txt
            echo "‚úÖ Combined transcript file size:"
            du -h build_output/master_transcript_combined.txt
          else
            echo "‚ö†Ô∏è No transcript files found. Skipping combine."
          fi

      - name: Commit and push updated transcripts
        run: |
          echo "üíæ Committing new combined transcript..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p transcripts
          if [ -f build_output/master_transcript_combined.txt ]; then
            cp build_output/master_transcript_combined.txt transcripts/master_transcript_combined.txt
            git add transcripts/master_transcript_combined.txt
            git commit -m "Auto-combined transcripts [skip ci]" || echo "‚ÑπÔ∏è No changes to commit"
            git push origin main
          else
            echo "‚ö†Ô∏è No combined transcript to commit."
          fi

      - name: Upload to OpenAI (optional)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ö†Ô∏è No OpenAI API key found. Skipping upload."
            exit 0
          fi

          echo "üì§ Uploading combined transcript to OpenAI..."
          python3 - <<'PYCODE'
          import os
          from openai import OpenAI

          key = os.environ.get("OPENAI_API_KEY")
          if not key:
              print("‚ö†Ô∏è No OpenAI key set ‚Äî skipping upload.")
              raise SystemExit(0)

          client = OpenAI(api_key=key)
          path = "transcripts/master_transcript_combined.txt"

          if os.path.exists(path):
              with open(path, "rb") as f:
                  client.files.create(file=f, purpose="assistants")
              print("‚úÖ Uploaded master transcript to OpenAI.")
          else:
              print("‚ö†Ô∏è Combined transcript not found ‚Äî skipping upload.")
          PYCODE
